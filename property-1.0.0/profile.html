<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>الملف الشخصي</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="shortcut icon" href="favicon.png" />
  <link rel="stylesheet" href="fonts/icomoon/style.css" />
  <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css" />

  <link rel="stylesheet" href="css/tiny-slider.css" />
  <link rel="stylesheet" href="css/aos.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="shortcut icon" href="favicon.png" />
  <style>
    body {
      background-color: #f7f7f7;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .profile-card {
      max-width: 500px;
      margin: 40px auto;
      padding: 25px;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
    }
    .profile-img {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 15px;
    }
    .btn-custom {
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div id="navbar-placeholder"></div>
<div class="profile-card">
  <img id="profileImage" src="https://placehold.co/110x110" alt="الصورة الشخصية" class="profile-img">
  <h4 id="username">...</h4>
  <p id="phone">رقم الهاتف: ...</p>
  <p id="userType">النوع: ...</p>

  <div class="btn-custom">
   <button class="btn btn-outline-primary w-100 mb-2" onclick="goToEdit()">✏️ تعديل الملف</button>

<!-- أزرار المؤجر -->
<div id="landlordOptions" style="display: none;">
  <button class="btn btn-outline-success w-100 mb-2" onclick="goToAddHousing()">➕ إضافة سكن</button>
  <button class="btn btn-outline-info w-100 mb-2" onclick="goToMyHousings()">🏠 السكن الذي أضفته</button>
</div>

<!-- إعدادات عامة -->
<button class="btn btn-outline-secondary w-100 mb-2" onclick="goToSettings()">⚙️ الإعدادات</button>
    <button class="btn btn-outline-danger w-100">🚪 تسجيل الخروج</button>
  </div>
</div>

<script>
   const token = localStorage.getItem("token");

function parseJwt(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(
      atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join('')
    );
    return JSON.parse(jsonPayload);
  } catch (e) {
    console.error("Invalid token", e);
    return null;
  }
}

if (!token) {
  alert("يجب تسجيل الدخول أولاً");
  window.location.href = "/login.html";
} else {
  const decoded = parseJwt(token);
  if (decoded) {
    const userId = decoded.nameid || decoded.uid || decoded.UserId;
    console.log("User ID from token:", userId);

    const apiUrl = `https://localhost:44327/api/Auth/UserById`;

    fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) throw new Error("فشل في تحميل البيانات");
      return response.json();
    })
    .then(data => {
      document.getElementById('username').textContent = data.fullName;
      document.getElementById('phone').textContent = `رقم الهاتف: ${data.phoneNumber}`;
      document.getElementById('userType').textContent = `النوع: ${data.role}`;
      document.getElementById('profileImage').src = data.profilePicture || "https://placehold.co/110x110";

      // لو مؤجر، أظهر خيارات المؤجر
      if (data.role === "Owner") {
        document.getElementById('landlordOptions').style.display = 'block';
      }
    })
    .catch(error => {
      console.error('خطأ أثناء تحميل بيانات المستخدم:', error);
      alert("حدث خطأ أثناء تحميل الملف الشخصي");
    });
  }
}
 function goToEdit() {
    window.location.href = `updateProfile.html`;
  }

  function goToAddHousing() {
    window.location.href = `add-housing.html`;
  }

  function goToMyHousings() {
    window.location.href = `houseSetting.html`;
  }

  function goToSettings() {
    window.location.href = `/settings.html?userId=${userId}`;
  }


</script>
 <script src="js/bootstrap.bundle.min.js"></script>
 <script src="js/tiny-slider.js"></script>
 <script src="js/aos.js"></script>
 <script src="js/navbar.js"></script>
 <script src="js/counter.js"></script>
 <script src="js/custom.js"></script>
 <script>
  fetch('Navbar.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('navbar-placeholder').innerHTML = data;
    });
</script>


</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تفاصيل الحجز</title>
   <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <link rel="stylesheet" href="fonts/icomoon/style.css" />
  <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css" />
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


  <link rel="stylesheet" href="css/tiny-slider.css" />
  <link rel="stylesheet" href="css/aos.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <link rel="stylesheet" href="css/fontawesome.min.css" />
  <style>
   
    
  #contractContent {
    direction: rtl;
    font-family: 'Cairo', sans-serif;
    color: #000;
    line-height: 1.8;
  }

  #contractContent p {
    page-break-inside: avoid;
    margin-bottom: 1rem;
  }

  @media print {
    #contractContent {
      page-break-inside: avoid;
    }
  }
</style>

  
</head>
<body>
   <div id="navbar-placeholder"></div>

  

<div class="container">
  <h2 class="text-center mb-4">تفاصيل الحجز</h2>
  <div id="reservationDetails" class="details-box mb-4"></div>

  <div class="text-center">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#contractModal">عرض العقد</button>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="contractModal" tabindex="-1" aria-labelledby="contractModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contractModalLabel">عقد الحجز</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body" id="contractContent">
        <p>جارٍ تحميل بيانات العقد...</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="downloadContractAsPDF()">تنزيل العقد </button>
      </div>
    </div>
  </div>
</div>
<div id="contractPrintClone" style="display: none;"></div>

<script>
    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6ImQxOGZiMmUxLWY0OTktNDZiZS05Y2NjLTBhOGVhZjdhYjA4MyIsInN1YiI6ImhlbmQ2MDc0IiwianRpIjoiOWQ4OGE1ZjYtOTk1NS00ZjY3LWJiNjYtM2E3YmE3ZmQ4ZTM5IiwiZW1haWwiOiJoZW5kQGguY29tIiwidWlkIjoiZDE4ZmIyZTEtZjQ5OS00NmJlLTljY2MtMGE4ZWFmN2FiMDgzIiwiZXhwIjoxNzQ5MDY5MjgyLCJpc3MiOiJTZWN1cmVBcGkiLCJhdWQiOiJTZWN1cmVBcGlVc2VyIn0.RYlFICCJgMFuEEpt9XN5FgQd35ApBEx6JK875RvTOvY";
  const urlParams = new URLSearchParams(window.location.search);
  const reservationId = urlParams.get('id');

  // تحميل تفاصيل الحجز
  fetch(`https://localhost:44327/api/Housing/reservation/${reservationId}`, {
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    }
  })
  .then(res => res.json())
  .then(data => {
    
    const date = new Date(data.reservationDate).toLocaleDateString("ar-EG");
    const html = `
      <p><strong>اسم المستأجر:</strong> ${data.tenantName}</p>
      <p><strong>العقار:</strong> ${data.housingAddress}</p>
      <p><strong>تاريخ الحجز:</strong> ${date}</p>
      <p><strong>المبلغ المدفوع:</strong> ${data.amountPaid} جنيه</p>
      <p><strong>الحالة:</strong> ${data.status === 0 ? "جاري المراجعة" : "مؤكد"}</p>
    `;
    document.getElementById("reservationDetails").innerHTML = html;
  });
  const contractModal = document.getElementById("contractModal");
  contractModal.addEventListener('show.bs.modal', function () {
    fetch(`https://localhost:44327/api/Housing/contract/${reservationId}`, {
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    })
    .then(res => res.json())
    .then(contract => {
  const date = new Date(contract.reservationDate).toLocaleDateString("ar-EG");
  const html = `
    <div style="font-size: 15px; line-height: 1.8;">
      <h3 style="text-align:center; margin-bottom: 20px;">عقد حجز السكن </h3>
      <hr />
      <p><strong>اسم المؤجر:</strong> ${contract.landlordName}</p>
      <p><strong>هاتف المؤجر:</strong> ${contract.landlordPhone}</p>
      <p><strong>اسم المستأجر:</strong> ${contract.tenantName}</p>
      <p><strong>هاتف المستأجر:</strong> ${contract.tenantPhone}</p>
      <p><strong>عنوان السكن:</strong> ${contract.housingAddress}</p>
      <p><strong>تاريخ الحجز:</strong> ${date}</p>
      <p><strong>المبلغ المتفق عليه:</strong> ${contract.amountPaid} جنيه</p>
      <hr />
      <h5>الشروط والأحكام:</h5>
      <ul style="padding-right: 20px;">
        <li>يتم الحجز بشكل مبدئي لمدة 7 أيام من تاريخ التوقيع.</li>
        <li>يُمنع إلغاء الحجز بعد مرور 3 أيام إلا بموافقة الطرفين.</li>
        <li>المبلغ المدفوع لا يُسترد في حالة عدم الالتزام بالحجز.</li>
        <li>يلتزم المؤجر بتسليم العقار في التاريخ المحدد والمتفق عليه.</li>
        <li>أي خلاف بين الطرفين يتم حله وديًا أو عبر الجهات المختصة.</li>
      </ul>
      <hr />
      <p><strong>توقيع المؤجر:</strong> _______________</p>
      <p><strong>توقيع المستأجر:</strong> _______________</p>
    </div>
  `;
  document.getElementById("contractContent").innerHTML = html;
});
  });

  // تحميل تفاصيل الحجز
  fetch(`https://localhost:44327/api/Housing/reservation/${reservationId}`, {
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    }
  })
  .then(res => res.json())
  .then(data => {
    
    const date = new Date(data.reservationDate).toLocaleDateString("ar-EG");
    const html = `
      <p><strong>اسم المستأجر:</strong> ${data.tenantName}</p>
      <p><strong>العقار:</strong> ${data.housingAddress}</p>
      <p><strong>تاريخ الحجز:</strong> ${date}</p>
      <p><strong>المبلغ المدفوع:</strong> ${data.amountPaid} جنيه</p>
      <p><strong>الحالة:</strong> ${data.status === 0 ? "جاري المراجعة" : "مؤكد"}</p>
    `;
    document.getElementById("reservationDetails").innerHTML = html;
  });

  
  async function downloadContractAsPDF() {
    const original = document.getElementById("contractContent");
    const cloneContainer = document.getElementById("contractPrintClone");

    if (!original || !original.innerHTML.trim()) {
      alert("لا يوجد محتوى لتحويله إلى PDF!");
      return;
    }

    // نسخ المحتوى إلى div خارج المودال
    cloneContainer.innerHTML = original.innerHTML;
    cloneContainer.style.display = "block";
    cloneContainer.style.position = "static";
    cloneContainer.style.background = "#fff";
    cloneContainer.style.padding = "20px";
    cloneContainer.style.width = "800px";
    cloneContainer.style.direction = "rtl";

    // إنشاء صورة للمحتوى
    const canvas = await html2canvas(cloneContainer, { scale: 2 });
    const imgData = canvas.toDataURL('image/jpeg', 1.0);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

    let position = 0;
    let heightLeft = pdfHeight;

    pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, pdfHeight);
    heightLeft -= pdf.internal.pageSize.getHeight();

    while (heightLeft > 0) {
      position = heightLeft - pdfHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, pdfHeight);
      heightLeft -= pdf.internal.pageSize.getHeight();
    }

    pdf.save("عقد_الحجز.pdf");

    // إخفاء العنصر المؤقت بعد التحميل
    cloneContainer.style.display = "none";
  }




</script>

<script src="js/bootstrap.bundle.min.js"></script>
 <script src="js/tiny-slider.js"></script>
   <script src="js/aos.js"></script>
   <script src="js/navbar.js"></script>
   <script src="js/counter.js"></script>
   <script src="js/custom.js"></script>
   <script>
  fetch('Navbar.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('navbar-placeholder').innerHTML = data;
    });
</script>
</body>
</html>
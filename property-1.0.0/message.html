<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>نظام المحادثة</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css"
  />
  <style>
    body {
      padding: 20px;
      background: #f5f7fa;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    .chat-container {
      display: flex;
      gap: 20px;
      max-width: 900px;
      margin: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 15px rgb(0 0 0 / 0.1);
      height: 600px;
      overflow: hidden;
    }
    .users-list {
      width: 250px;
      background: #fff;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      padding: 10px;
    }
    .user-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f0f0f0;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .user-item:hover {
      background: #cce4ff;
    }
    .user-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  margin-right: 10px;
}

.user-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
    .user-name {
      font-weight: 600;
      font-size: 16px;
      color: #333;
      user-select: none;
    }
    .chat-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
      background: #fafafa;
    }
    #chatWindow.hidden {
      display: none;
    }
    #messagesBox {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: white;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-message {
      max-width: 70%;
      padding: 12px 15px;
      border-radius: 20px;
      font-size: 14px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    }
    .sent {
      align-self: flex-end;
      background-color: #dcf8c6;
      text-align: right;
      border-bottom-right-radius: 0;
    }
    .received {
      align-self: flex-start;
      background-color: #fff;
      border: 1px solid #ddd;
      border-bottom-left-radius: 0;
    }
    .message-time {
      font-size: 11px;
      color: #888;
      margin-top: 5px;
      display: block;
      user-select: none;
    }
    form {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    textarea#messageContent {
      flex-grow: 1;
      resize: none;
      height: 60px;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 14px;
      font-family: inherit;
    }
    button#sendBtn {
      padding: 0 20px;
      border-radius: 10px;
    }
    #backBtn {
      align-self: flex-start;
      margin-bottom: 10px;
    }
    #chatWithName {
      margin-bottom: 10px;
      font-weight: 700;
      font-size: 20px;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- قائمة المستخدمين -->
    <div class="users-list" id="usersContainer"></div>

    <!-- نافذة المحادثة -->
    <div class="chat-box hidden" id="chatWindow">
      <button class="btn btn-sm btn-secondary" id="backBtn">⬅ رجوع</button>
      <h4 id="chatWithName">المحادثة مع ...</h4>
      <div id="messagesBox"></div>

      <form id="messageForm">
        <input type="hidden" id="senderId" />
        <input type="hidden" id="receiverId" />
        <textarea
          id="messageContent"
          placeholder="اكتب رسالتك..."
          required
        ></textarea>
        <button type="submit" id="sendBtn" class="btn btn-primary">إرسال</button>
      </form>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");

    function parseJwt(token) {
      try {
        const base64Payload = token.split(".")[1];
        const payload = atob(base64Payload.replace(/-/g, "+").replace(/_/g, "/"));
        return JSON.parse(payload);
      } catch (e) {
        return null;
      }
    }

    const decodedToken = parseJwt(token);
    const senderId = decodedToken?.uid || decodedToken?.sub || null;
    document.getElementById("senderId").value = senderId;

    const usersContainer = document.getElementById("usersContainer");
    const receiverInput = document.getElementById("receiverId");
    const messagesBox = document.getElementById("messagesBox");
    const messageForm = document.getElementById("messageForm");
    const chatWindow = document.getElementById("chatWindow");
    const chatWithName = document.getElementById("chatWithName");
    const backBtn = document.getElementById("backBtn");

    let autoRefreshInterval;

    // تحميل المستخدمين
    async function loadUsers() {
      try {
        const res = await fetch("https://localhost:44327/api/Auth/AllUsers");
        const users = await res.json();

        usersContainer.innerHTML = "";

       users.forEach((user) => {
  if (user.id === senderId) return; // تجاهل نفس المستخدم

  const userDiv = document.createElement("div");
  userDiv.className = "user-item";
  userDiv.setAttribute("data-id", user.id);
  userDiv.setAttribute("data-name", user.fullName);

  // عنصر الصورة أو الأيقونة
  const icon = document.createElement("div");
  icon.className = "user-icon";

  if (user.profilePicture) {
    const img = document.createElement("img");
    img.src = user.profilePicture;
    img.alt = user.fullName;
    img.className = "user-img"; // أضف هذه الكلاسات للتنسيق
    icon.appendChild(img);
  } else {
    icon.textContent = user.fullName[0]?.toUpperCase() || ".";
  }

  const nameSpan = document.createElement("span");
  nameSpan.className = "user-name";
  nameSpan.textContent = user.fullName;

  userDiv.appendChild(icon);
  userDiv.appendChild(nameSpan);

  userDiv.addEventListener("click", () => {
    receiverInput.value = user.id;
    chatWithName.textContent = `المحادثة مع ${user.fullName}`;
    chatWindow.classList.remove("hidden");
    loadMessages(senderId, user.id);
    startAutoRefresh(senderId, user.id);
  });

  usersContainer.appendChild(userDiv);
});

      } catch (err) {
        console.error("فشل في تحميل المستخدمين", err);
      }
    }

    // تحميل الرسائل
    async function loadMessages(sender, receiver) {
      try {
        const res = await fetch(
          `https://localhost:44327/api/Message/getMessage/${sender}/${receiver}`
        );
        const messages = await res.json();

        messagesBox.innerHTML = "";
        messages.forEach((msg) => {
          const msgDiv = document.createElement("div");
          msgDiv.className = `chat-message ${
            msg.senderId === senderId ? "sent" : "received"
          }`;

          const messageText = document.createElement("div");
          messageText.textContent = msg.content;

          const time = document.createElement("span");
          const date = new Date(msg.sentAt || new Date());
          time.className = "message-time";
          time.textContent = date.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          msgDiv.appendChild(messageText);
          msgDiv.appendChild(time);

          messagesBox.appendChild(msgDiv);
        });

        messagesBox.scrollTop = messagesBox.scrollHeight;
      } catch (err) {
        console.error("فشل في تحميل الرسائل", err);
      }
    }

    // إرسال رسالة
    messageForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const dto = {
        senderId: senderId,
        receiverId: receiverInput.value,
        content: document.getElementById("messageContent").value,
      };

      try {
        const res = await fetch("https://localhost:44327/api/Message/sendMessage", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dto),
        });

        if (res.ok) {
          document.getElementById("messageContent").value = "";
          loadMessages(dto.senderId, dto.receiverId);
        } else {
          alert("فشل إرسال الرسالة");
        }
      } catch (err) {
        console.error("فشل الإرسال", err);
      }
    });

    // التحديث التلقائي للرسائل
   document.getElementById("backBtn").addEventListener("click", () => {
    document.getElementById("chatWindow").classList.add("hidden");
    receiverInput.value = "";
    clearInterval(autoRefreshInterval);
  });

  loadUsers();
</script>

</body>
</html>
